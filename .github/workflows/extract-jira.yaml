name: Extract JIRA IDs

on:
  workflow_call:
    outputs:
      jira_ids:
        description: "Extracted and formatted JIRA IDs"
        value: ${{ jobs.extract-jira.outputs.jira_ids }}

jobs:
  extract-jira:
    name: Extract JIRA IDs
    runs-on: ubuntu-latest
    outputs:
      jira_ids: ${{ steps.extract_jira.outputs.jira_ids }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract JIRA IDs (since previous release)
        id: extract_jira
        run: |
          set -euo pipefail

          # Bir Ã¶nceki tag
          prev_tag=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          if [ -n "$prev_tag" ]; then
            echo "Previous tag: $prev_tag"
            range="$prev_tag..HEAD"
          else
            echo "No previous tag found. Scanning last 200 commits as fallback."
            range="--max-count=200"
          fi

          echo "ğŸ” Checking commits in range: $range"
          echo "----------------------------------------"
          git log $range --oneline --decorate
          echo "----------------------------------------"

          # TÃ¼m commit mesajlarÄ±
          commit_messages=$(git log $range --pretty=%B)

          # JIRA ID'lerini yakala (benzersiz ve sÄ±ralÄ±)
          jira_ids=$(printf '%s' "$commit_messages" | grep -oE '\b[A-Z][A-Z0-9]+-[0-9]+\b' | sort -u)

          if [ -n "$jira_ids" ]; then
            echo "âœ… Found JIRA IDs:"
            echo "$jira_ids"

            # Markdown link formatÄ± + virgÃ¼lle ayÄ±r
            formatted_jiras=$(
              printf '%s\n' "$jira_ids" \
              | sed -E 's#^([A-Z][A-Z0-9]+-[0-9]+)$#[\1](https://elektrawebpms.atlassian.net/browse/\1)#' \
              | paste -sd ', '
            )

            # Ã‡ok satÄ±rlÄ± output'u temiz ÅŸekilde yaz
            {
              echo "jira_ids<<EOF"
              echo "$formatted_jiras"
              echo "EOF"
            } >> "$GITHUB_OUTPUT"
          else
            echo "âš ï¸ No JIRA IDs found."
            echo "jira_ids=" >> "$GITHUB_OUTPUT"
          fi
