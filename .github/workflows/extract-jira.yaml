name: Extract JIRA IDs
on:
  workflow_call:
    outputs:
      jira_ids:
        description: Extracted and formatted JIRA IDs
        value: ${{ jobs.extract-jira.outputs.jira_ids }}
jobs:
  extract-jira:
    name: Extract JIRA IDs
    runs-on: ubuntu-latest
    outputs:
      jira_ids: ${{ steps.extract_jira.outputs.jira_ids }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Extract JIRA IDs
        id: extract_jira
        run: |
          set -euo pipefail
          prev_tag=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          if [ -n "$prev_tag" ]; then
            range="$prev_tag..HEAD"
          else
            range="--max-count=200"
          fi
          commit_messages=$(git log $range --pretty=%B)
          jira_ids=$(printf '%s' "$commit_messages" | grep -oE '\b[A-Z][A-Z0-9]+-[0-9]+\b' | sort -u)
          if [ -n "$jira_ids" ]; then
            formatted_jiras=$(printf '%s\n' "$jira_ids" | sed -E 's#^([A-Z][A-Z0-9]+-[0-9]+)$#[\1](https://elektrawebpms.atlassian.net/browse/\1)#' | paste -sd ', ')
            echo "jira_ids<<EOF" >> "$GITHUB_OUTPUT"
            echo "$formatted_jiras" >> "$GITHUB_OUTPUT"
            echo "EOF" >> "$GITHUB_OUTPUT"
          else
            echo "jira_ids=" >> "$GITHUB_OUTPUT"
          fi
