name: Create Release & Build Docker

on:
  workflow_dispatch:

jobs:
  semantic-release:
    name: Semantic Release
    uses: ./.github/workflows/semantic-release.yaml

  build-docker:
    needs: semantic-release
    if: needs.semantic-release.outputs.new_release_published == 'true'
    name: Build & Push Docker
    uses: ./.github/workflows/build-docker.yaml
    with:
      version: ${{ needs.semantic-release.outputs.new_release_version }}

  create-branch:
    needs: semantic-release
    if: needs.semantic-release.outputs.new_release_published == 'true'
    name: Create Release Branch
    uses: ./.github/workflows/create-branch.yaml
    with:
      version: ${{ needs.semantic-release.outputs.new_release_version }}

  #  deploy:
  #    needs: [ semantic-release, build-docker ]
  #    if: needs.semantic-release.outputs.new_release_published == 'true'
  #    name: Deploy to Kubernetes
  #    strategy:
  #      matrix:
  #        obj:
  #          - namespace: elektraweb
  #            deployment: angus
  #            container: angus
  #          - namespace: angus
  #            deployment: angus
  #            container: angus
  #    uses: travelaps/k8s-rollout/.github/workflows/rollout-azure.yml@main
  #    with:
  #      namespace: ${{ matrix.obj.namespace }}
  #      deploymentSelector: k8s-app=${{ matrix.obj.deployment }}
  #      containerName: ${{ matrix.obj.container }}
  #      containerImage: ghcr.io/${{ vars.CRNAME }}/${{ matrix.obj.container }}:v${{ needs.semantic-release.outputs.new_release_version }}

  call-notify:
    needs: [ semantic-release, build-docker ]
    if: needs.semantic-release.outputs.new_release_published == 'true'
    uses: NecimDurmaz/github-action-yamls/.github/workflows/notify-teams.yaml@main
    with:
      message: |
        # üìÅ **${{ github.repository }}** 
        ## üöÄ New release published: **${{ needs.semantic-release.outputs.new_release_version }}**
        ---
        # üìù **Release Notes:** 
           ${{ needs.semantic-release.outputs.changelog_diff }}
        ---
        ‚úÖ Docker image built and deployed successfully!
    secrets:
      TEAMS_WEBHOOK: ${{ secrets.TEAMS_WEBHOOK }}  # <-- kapanƒ±≈ü }} eklendi

